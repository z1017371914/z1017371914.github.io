## 行锁

1.`行锁`：**Engine层实现**，不是所有的引擎都支持行锁。

2.行锁使用了两阶段锁协议，所以一个事务的小操作中是可以改变顺序的，因此应该`将涉及到最多行锁的更改放到最后面，减少锁冲突`。

---



假设你负责实现一个电影票在线交易业务，顾客 A 要在影院 B 购买电影票。我们简化一
点，这个业务需要涉及到以下操作：

1. 从顾客 A 账户余额中扣除电影票价；

2. 给影院 B 的账户余额增加这张电影票价；

3. 记录一条交易日志。

也就是说，要完成这个交易，我们需要 update 两条记录，并 insert 一条记录。当然，为
了保证交易的原子性，我们要把这三个操作放在一个事务中。那么，你会怎样安排这三个
语句在事务中的顺序呢？
试想如果同时有另外一个顾客 C 要在影院 B 买票，那么这两个事务冲突的部分就是语句 2
了。因为它们要更新同一个影院账户的余额，需要修改同一行数据。
根据两阶段锁协议，不论你怎样安排语句顺序，所有的操作需要的行锁都是在事务提交的
时候才释放的。所以，如果你把语句 2 安排在最后，比如按照 3、1、2 这样的顺序，那么
影院账户余额这一行的锁时间就最少。这就最大程度地减少了事务之间的锁等待，提升了
并发度

----



